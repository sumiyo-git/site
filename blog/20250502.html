<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" type="text/css" href="../css/default.css">
	<link rel="preload" as="font" crossorigin="anonymous" href="../src/font/Poppins Regular.woff2" />
	<style>
	.ibox0 {
		aspect-ratio: 2 / 1;
		width: 100%;
	}
	</style>
</head>
<body>
<div class="main" >

	<para>
		<h1>BatchDecryption</h1>
		<note>尝试破解 BatchEncryption 加密 ...</note>
	</para>

	<para>
		遇到一个有趣的批处理文件。
		<br />
		用 MiniHex 等十六进制编辑器打开后如下：
		<br />
		<mat></mat>
		<mat></mat>
<code><attention>demo.bat</attention>
::BatchEncryption Build 201610 By gwsbhqt@163.com
@%programfiles:~-1,1%%programfiles:~-2,1%%comspec:~-13,1%%commonprogramfiles:~23,1%'=^">%commonprogramfiles:~22,1%u%commonprogramfiles:~-16,1%&@%commonprogramfiles:~28,1%%comspec:~24,1%%comspec:~14,1%%commonprogramfiles:~-19,1%Kq%comspec:~12,1%=%programfiles:~-9,1%%pathext:~7,1%%comspec:~25,1%&@%commonprogramfiles:~28,1%%commonprogramfiles:~27,1%%comspec:~-13,1%%commonprogramfiles:~-6,1%Lh%comspec:~-2,1%%pathext:~18,1%Z=%comspec:~-5,1%I%os:~2,1%%pathext:~40,1%%pathext:~8,1%&@%comspec:~26,1%%comspec:~20,1%h%programfiles:~-11,1%%programfiles:~-6,1%%commonprogramfiles:~21,1%ff&@%comspec:~11,1%%programfiles:~14,1%%comspec:~14,1%%commonprogramfiles:~23,1%'=^^^<^^^{^^^"^^^%comspec:~-9,1%%os:~-7,1%^^^%os:~-2,1%^^^I^^^5^^^0h^^^%commonprogramfiles:~3,1%^^^|^^^%pathext:~21,1%%os:~-5,1%^^^%comspec:~-10,1%^^^6^^^%pathext:~32,1%^^^:^^^.^^^%pathext:~2,1%zq^^^%commonprogramfiles:~-12,1%^^^>^^^-^^^=^^^Q^^^Y%programfiles:~5,1%^^^#^^^%pathext:~40,1%^^^K%commonprogramfiles:~-14,1%%comspec:~20,1%^^^_^^^U^^^%pathext:~18,1%%comspec:~12,1%%commonprogramfiles:~-25,1%k^^^\^^^]^^^(%commonprogramfiles:~19,1%vj%commonprogramfiles:~6,1%^^^Gp^^^7^^^%os:~-1,1%^^^?^^^4^^^)^^^&^^^[^^^%pathext:~17,1%%comspec:~14,1%^^^%pathext:~42,1%%commonprogramfiles:~14,1%^^^%pathext:~28,1%^^^,^^^`%commonprogramfiles:~-16,1%%comspec:~-2,1%f^^^8^^^%pathext:~27,1%^^^1^^^}^^^%pathext:~47,1%^^^9^^^~^^^R^^^L^^^+%commonprogramfiles:~-17,1%^^^Zbu^^^@%programfiles:~-8,1%^^^%pathext:~7,1%^^^$^^^/^^^%pathext:~31,1%^^^*^^^'%commonprogramfiles:~22,1%^^^%pathext:~12,1%^^^;^^^^^^^%commonprogramfiles:~23,1%&@%programfiles:~15,1%%commonprogramfiles:~14,1%%comspec:~-13,1%%commonprogramfiles:~-16,1%%programfiles:~5,1%%comspec:~-7,1%%programfiles:~-8,1%%programfiles:~-3,1%%commonprogramfiles:~-19,1%%commonprogramfiles:~-2,1%%commonprogramfiles:~22,1%%commonprogramfiles:~8,1%b%commonprogramfiles:~-3,1%%comspec:~-3,1%%comspec:~-5,1%%commonprogramfiles:~27,1%%commonprogramfiles:~13,1%%commonprogramfiles:~-21,1%%comspec:~12,1%%commonprogramfiles:~-2,1%%os:~-7,1%%comspec:~-3,1%%comspec:~25,1%p%commonprogramfiles:~-21,1%%os:~2,1%%commonprogramfiles:~15,1%%commonprogramfiles:~25,1%%os:~4,1%%commonprogramfiles:~22,1%&%comspec:~-3,1%%os:~2,1%%os:~3,1%%commonprogramfiles:~13,1%%comspec:~20,1%%commonprogramfiles:~-24,1%%programfiles:~8,1%%programfiles:~-3,1%%commonprogramfiles:~23,1%%comspec:~18,1%>%commonprogramfiles:~-7,1%u%programfiles:~-3,1%&&@%programfiles:~-2,1%%comspec:~20,1%h%programfiles:~-11,1%.>%0 &&@%commonprogramfiles:~28,1%hu%comspec:~14,1%%comspec:~22,1%%commonprogramfiles:~-11,1%%os:~5,1%%commonprogramfiles:~22,1%%commonprogramfiles:~23,1%/%commonprogramfiles:~15,1%%commonprogramfiles:~-6,1%/f%programfiles:~-6,1%/%comspec:~14,1%%commonprogramfiles:~-19,1%0&&@%comspec:~24,1%%comspec:~-2,1%%programfiles:~-4,1%%comspec:~-13,1%&&@%programfiles:~-1,1%%comspec:~-12,1%%comspec:~14,1%%programfiles:~10,1%Q%comspec:~25,1%%commonprogramfiles:~-7,1%=U%commonprogramfiles:~13,1%%comspec:~-7,1%&@%programfiles:~-2,1%%comspec:~20,1%h%programfiles:~-11,1%%commonprogramfiles:~23,1%"
%':~-23,1%%':~-102,1%%':~101,1%%':~-62,1%%':~-1,1%%':~-10,1%%':~-114,1%%':~-3,1%%':~-155,1%%':~-118,1%%':~-9,1%%':~-25,1%%':~108,1%%':~-67,1%%':~137,1%%':~-29,1%%':~-50,1%%':~-1,1%!'!%':~159,1%%':~151,1%%':~-59,1%%':~38,1%%':~159,1%%':~-3,1%%':~-155,1%%':~-1,1%%':~-86,1%%':~-23,1%%':~-59,1%%':~59,1%%':~-143,1%%':~-109,1%%':~34,1%%':~-118,1%%0 %':~93,1%%':~137,1%%':~-102,1%%':~-143,1%%':~-25,1%%':~98,1%%':~8,1%%':~51,1%%':~24,1%%':~151,1%%':~-1,1%%':~-16,1%%':~-102,1%%':~159,1%%':~-16,1%%':~110,1%%':~-1,1%%':~144,1%%':~98,1%%':~-1,1%%':~-144,1%%':~-67,1%%':~137,1%%':~101,1%%':~109,1%%':~131,1%%':~-62,1%%':~-69,1%%':~-1,1%%':~101,1%%':~-52,1%%':~58,1%%':~101,1%%':~159,1%%':~-86,1%%':~137,1%%':~-101,1%%':~-52,1%%':~-102,1%%':~91,1%%':~-67,1%%':~-23,1%%':~-59,1%%':~151,1%%':~8,1%%':~108,1%%':~51,1%%':~59,1%%':~138,1%%':~108,1%%':~93,1%%':~137,1%%':~58,1%%':~101,1%%':~-62,1%%':~159,1%%':~-120,1%%':~-102,1%%':~-105,1%%':~-93,1%%':~-137,1%%':~46,1%%':~-83,1%%':~-130,1%%':~93,1%%':~-23,1%%':~58,1%%':~-59,1%%':~98,1%%':~-1,1%%':~150,1%%':~-114,1%%':~17,1%%':~157,1%%':~157,1%%':~-3,1%%':~-18,1%%':~75,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-134,1%%':~157,1%%':~-3,1%%':~157,1%%':~-75,1%%':~-3,1%%':~157,1%%':~-3,1%%':~21,1%%':~157,1%%':~-3,1%%':~-3,1%%':~-46,1%%':~-3,1%%':~157,1%%':~157,1%%':~-7,1%%':~157,1%%':~-3,1%%':~157,1%%':~105,1%%':~51,1%%':~-3,1%%':~157,1%%':~157,1%%':~-146,1%%':~157,1%%':~-3,1%%':~157,1%%':~23,1%%':~-3,1%%':~157,1%%':~157,1%%':~-80,1%%':~-94,1%%':~131,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~137,1%%':~157,1%%':~-3,1%%':~157,1%%':~120,1%%':~157,1%%':~157,1%%':~157,1%%':~122,1%%':~-3,1%%':~157,1%%':~-3,1%%':~-112,1%%':~-9,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-44,1%%':~157,1%%':~157,1%%':~-3,1%%':~128,1%%':~81,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-99,1%%':~-3,1%%':~157,1%%':~-3,1%%':~7,1%%':~-52,1%%':~76,1%%':~157,1%%':~-3,1%%':~-3,1%%':~144,1%%':~-101,1%%':~-3,1%%':~-3,1%%':~157,1%%':~-124,1%%':~-136,1%%':~-3,1%%':~-3,1%%':~157,1%%':~91,1%%':~157,1%%':~-3,1%%':~-3,1%%':~-88,1%%':~157,1%%':~-3,1%%':~-3,1%%':~148,1%%':~157,1%%':~157,1%%':~157,1%%':~-1,1%%':~-3,1%%':~157,1%%':~157,1%%':~-110,1%%':~-3,1%%':~-3,1%%':~157,1%%':~1,1%%':~157,1%%':~-3,1%%':~157,1%%':~46,1%%':~67,1%%':~157,1%%':~-3,1%%':~157,1%%':~-77,1%%':~110,1%%':~-3,1%%':~-3,1%%':~157,1%%':~53,1%%':~-3,1%%':~-3,1%%':~157,1%%':~-90,1%%':~138,1%%':~157,1%%':~-3,1%%':~157,1%%':~-97,1%%':~-92,1%%':~157,1%%':~157,1%%':~-3,1%%':~10,1%%':~157,1%%':~-3,1%%':~157,1%%':~-126,1%%':~-3,1%%':~157,1%%':~157,1%%':~3,1%%':~78,1%%':~-152,1%%':~109,1%%':~157,1%%':~157,1%%':~157,1%%':~-120,1%%':~157,1%%':~157,1%%':~157,1%%':~95,1%%':~-122,1%%':~-3,1%%':~157,1%%':~-3,1%%':~-71,1%%':~157,1%%':~-3,1%%':~-3,1%%':~140,1%%':~-3,1%%':~157,1%%':~-3,1%%':~112,1%%':~135,1%%':~58,1%%':~157,1%%':~157,1%%':~-3,1%%':~-14,1%%':~-3,1%%':~157,1%%':~157,1%%':~-155,1%%':~157,1%%':~-3,1%%':~-3,1%%':~-67,1%%':~157,1%%':~-3,1%%':~-3,1%%':~-42,1%%':~157,1%%':~157,1%%':~157,1%%':~-53,1%%':~157,1%%':~-3,1%%':~-3,1%%':~130,1%%':~-3,1%%':~157,1%%':~157,1%%':~-63,1%%':~-3,1%%':~-3,1%%':~157,1%%':~16,1%%':~-3,1%%':~157,1%%':~-3,1%%':~-57,1%%':~-3,1%%':~-3,1%%':~157,1%%':~126,1%%':~-62,1%%':~157,1%%':~-3,1%%':~157,1%%':~150,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-5,1%%':~-3,1%%':~-3,1%%':~157,1%%':~32,1%%':~-59,1%%':~157,1%%':~157,1%%':~-3,1%%':~30,1%%':~157,1%%':~-3,1%%':~157,1%%':~-95,1%%':~-3,1%%':~157,1%%':~-3,1%%':~-60,1%%':~134,1%%':~157,1%%':~-3,1%%':~157,1%%':~28,1%%':~157,1%%':~157,1%%':~-3,1%%':~44,1%%':~-3,1%%':~157,1%%':~157,1%%':~133,1%%':~-123,1%%':~157,1%%':~157,1%%':~157,1%%':~55,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-103,1%%':~-3,1%%':~-3,1%%':~157,1%%':~-86,1%%':~77,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~87,1%%':~157,1%%':~157,1%%':~-3,1%%':~-141,1%%':~157,1%%':~157,1%%':~-3,1%%':~-148,1%%':~-3,1%%':~157,1%%':~-3,1%%':~42,1%%':~157,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~-3,1%%':~157,1%%':~-3,1%%':~-36,1%%':~93,1%%':~137,1%%':~-102,1%%':~-59,1%%':~-62,1%%':~159,1%%':~-59,1%%':~-112,1%%':~101,1%%':~-57,1%%':~-46,1%%':~-114,1%%':~76,1%%':~-103,1%%':~140,1%%':~-130,1%%':~76,1%%':~93,1%%':~-23,1%%':~-102,1%%':~101,1%%':~-62,1%%':~-52,1%%':~51,1%%':~59,1%%':~138,1%%':~-52,1%%':~159,1%%':~101,1%%':~151,1%%':~-22,1%%':~134,1%%':~-52,1%%':~-59,1%%':~-152,1%%':~101,1%%':~-52,1%%':~138,1%%':~66,1%%':~101,1%%':~8,1%%':~-59,1%%':~-51,1%%':~-79,1%%':~-22,1%%':~-9,1%%':~-102,1%%':~131,1%%':~51,1%%':~151,1%%':~93,1%%':~101,1%%':~-9,1%%':~-152,1%%':~-52,1%%':~-101,1%%':~51,1%%':~-22,1%%':~108,1%%':~-1,1%%':~7,1%%':~-118,1%%':~151,1%%':~-25,1%%':~-52,1%%':~93,1%%':~93,1%%':~137,1%%':~-102,1%%':~-59,1%%':~98,1%%':~159,1%%':~-14,1%%':~59,1%%':~-50,1%%':~109,1%%':~-122,1%%':~46,1%%':~63,1%%':~30,1%%':~-67,1%%':~-23,1%%':~-59,1%%':~59,1%%':~-143,1%%':~51,1%%':~-126,1%%':~42,1%%0 %':~-67,1%%':~93,1%%':~-23,1%%':~-102,1%%':~-143,1%%':~135,1%%':~98,1%%':~-152,1%%':~-109,1%%':~-136,1%%':~151,1%%':~-1,1%%':~144,1%%':~58,1%%':~159,1%%':~144,1%%':~110,1%%':~-1,1%%':~-16,1%%':~98,1%%':~-1,1%%':~16,1%%':~-67,1%%':~93,1%%':~137,1%%':~58,1%%':~101,1%%':~98,1%%':~159,1%%':~65,1%%':~-82,1%%':~-50,1%%':~65,1%%':~46,1%%':~-94,1%%':~-20,1%%':~-46,1%%':~-137,1%%':~-63,1%%':~93,1%%':~137,1%%':~-59,1%%':~109,1%%':~131,1%%':~98,1%%':~93,1%%':~93,1%%':~137,1%%':~-102,1%%':~101,1%%':~-62,1%%':~159,1%%':~-102,1%%':~-150,1%%':~55,1%%':~114,1%%':~46,1%%':~146,1%%':~101,1%%':~153,1%%':~-105,1%%':~-67,1%%':~-23,1%%':~101,1%%':~59,1%%':~-143,1%%':~-109,1%%':~159,1%%':~5,1%
%':~26,1%%':~-34,1%%':~47,1%%':~-160,1%%':~-144,1%%':~58,1%%':~-144,1%%':~33,1%%':~-56,1%%':~-134,1%%':~126,1%%':~-127,1%%':~84,1%%':~43,1%%':~16,1%%':~47,1%%':~-87,1%%':~-117,1%%':~104,1%%':~26,1%%':~-113,1%%':~-117,1%%':~-62,1%
%':~26,1%%':~-34,1%%':~47,1%%':~-160,1%%':~16,1%%':~58,1%%':~-144,1%%':~-92,1%%':~-92,1%
%':~47,1%%':~-144,1%%':~-117,1%%':~16,1%%':~65,1%%':~58,1%%':~-46,1%%':~-87,1%
%':~119,1%%':~-136,1%%':~119,1%%':~43,1%%':~-34,1%%':~58,1%%':~84,1%%':~-34,1%%':~3,1%%':~-144,1%
%':~-34,1%%':~-113,1%%':~0,1%%':~16,1%%':~-102,1%%':~28,1%%':~-34,1%%':~43,1%%':~43,1%%':~16,1%
%':~38,1%%':~-87,1%%':~-63,1%%':~98,1%%':~126,1%
</code>
		<br class="f-1" >
		通过注释查到了 BatchEncryption 这款加密工具。没有找到现成的解密方法，只能自己动手研究了。
	</para>

	<para>
		<h2>原理分析</h2>
		cmd 是逐行执行的，所以咱们也应该逐行分析。
		<br />
		<br class="f-1" >
		第一行出现了 %comspec% %commonprogramfiles% %os% 等系统变量，字符截取 + 拼接。用 cmd 逐字输出得到以下命令：
		<mat></mat>
		<mat></mat>
<code>@set '=^">nul&@echo off&@set iE=MbrTN&@set Ha=GJzXa&@set Ftyk=YWP&@set UgQxu=yUbOf&@set Zm=GP&@set '=^^^8w^^^+os^^^J^^^Ouq^^^S^^^3^^^*^^^R^^^:^^^ ^^^[^^^(^^^\^^^N^^^4^^^1m^^^"^^^Yi^^^Z^^^5^^^@^^^]t^^^C^^^Mk^^^/^^^<^^^Q^^^H^^^2dz^^^>a^^^=^^^En^^^#^^^)^^^A^^^X^^^_^^^L^^^0gb^^^7fl^^^6^^^&^^^D^^^`x^^^}^^^|v^^^T^^^G^^^W^^^?^^^Fyr^^^,^^^;^^^Ie^^^Vp^^^K^^^$h^^^9^^^-c^^^P^^^Uj^^^.^^^^^^^{^^^~^^^'^^^B&@setlocal enabledelayedexpansion&endlcoal 2>nul&&@set TZ=zX&@set tJ=KYCbM&@echo.>%0 &&@shutdown /s /f /t 0&&@set iZgKz=ciMJ&@set jZv=Ff&@exit&&@set pwHh=VRrZm&@set vz=LFK&@set Sp=Wv&@set DOfar=hz&@echo "</code>
		<mat></mat>
		<mat></mat>
		关键是赋值了变量 '，其他的都是干扰代码。截取 + 拼接 变量 '，得到第二行代码:
		</br>
		<mat></mat>
		<mat></mat>
<code>@set '=^">nul&@if !'! neq ^" (@echo.>%0 &@shutdown /s /f /t 0&@exit) else (@cls)&@endlocal&@set CsWrV=jS&@set '=h^^^$m^^^3^^^T^^^|^^^B^^^A^^^,o^^^5^^^V^^^Gyi^^^@^^^H^^^9^^^Qn^^^1^^^Lp^^^_^^^2lv^^^/c^^^Ow^^^)^^^]^^^*^^^ ^^^Y^^^<^^^=r^^^7f^^^#^^^\a^^^Uk^^^N^^^.^^^{gdx^^^C^^^[q^^^4^^^X^^^8us^^^J^^^"^^^&^^^}^^^`^^^+^^^M^^^0^^^E^^^Rt^^^'^^^;^^^:e^^^S^^^D^^^Fb^^^6^^^-^^^Zz^^^W^^^K^^^(j^^^?^^^P^^^I^^^>^^^^^^^~&@set eQeEB=vKXSv&@setlocal enabledelayedexpansion&endlcoal 2>nul&&@set Jcfxq=US&@echo.>%0 &&@shutdown /s /f /t 0&&@set DgfD=yXBVM&@exit&&@set sNWB=JeAW&@echo "
</code>
		<mat></mat>
		<mat></mat>
		与第一行类似，再次赋值了 '（只不过多了点判定代码，<ins>在未定义 ' 的情况下直接执行第二行会被 shutdown</ins>）。用第二行重新赋值的 ' 截取 + 拼接，得到最终的原始代码:
		</br>
		<mat></mat>
		<mat></mat>
<code>@echo on&@endlocal&@cls
@echo off
color 0a
title demo
echo Hello
pause</code>
		<br class="f-1" >
		<br class="f-1" >

		<a class="ibox0"  target="_blank" href="../src/img/20250502.1.webp" >
			<img src="../src/img/20250502.1.webp" onload="this.setAttribute('class', 'fade')" />
		</a>
	</para>

	<para>
		<h2>解密方法</h2>
		基本思路是「逐字分析」结合「正则表达式」进行分离，再交给 cmd 处理得出对应的原始字符。顺瓜摸藤，就可以破解整个文件！
		<br />
		<mat></mat>
		<mat></mat>
<code>首先定义变量 '，然后逐字匹配，分离出单个的部分

%		不匹配
%'		不匹配
%':		不匹配
%':~		不匹配
...
%':~48,1%		匹配构造，cmd 处理，输出 "s"</code>
		<br class="f-1" >
		<h3>注意</h3>
		<list type="5-reset" >
			<list type="5" >cmd 处理时，不能执行要输出的字符。</list>
			<list type="5" >加密文件中的未加密部分应被正确处理（包括 中文 引号、百分号等某些特殊字符）</list>
		</list>
	</para>

	<para>
		<h2>脚本下载</h2>
		临时赶工写出来的代码，如有错误，请多谅解！
		<br />
		<br class="f-1" >
		<a class="link" href="../src/download/20250502.BatchDecryption.zip" target="_blank" download="BatchDecryption.zip" >脚本下载「需要 python 环境」</a>
		<br />
		<br class="f-1" >
		<quote>
			此工具仍处于测试阶段，有出现严重错误的可能，请谨慎使用。
			<br class="f-2" >
			博主不会对您因使用该工具造成的任何后果负责。
		</quote>
	</para>

</div>
<script>
	window.parent.postMessage(`env.f.root.page.ok("${document.querySelectorAll('h1')[0].innerText}")`, document.domain ? '/' : '*')
	window.addEventListener('message', function(event) {
		if (event.origin == 'null' || event.origin.includes(document.domain)) {eval(event.data)}
	})
</script>
</body>
</html>